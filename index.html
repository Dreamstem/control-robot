<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DREAMSTEAM Robot Control</title>
    <!-- ¡Aquí está la meta etiqueta de verificación de Google Search Console! -->
    <meta name="google-site-verification" content="DxWzq6orsVZ4wTTyPv21cri5ZKaZ_5Ef3oEQX1qxrDc" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NOTE: KaTeX library has been completely removed -->
    <style>
        /* Custom styles for a polished look and feel */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Light mode base styles */
        body {
            background-color: #f0f2f5; 
            color: #1f2937; /* gray-800 */
        }

        /* Dark mode base styles */
        body.dark {
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* gray-200 */
        }

        .screen, .modal-content {
            background-color: white;
            transition: background-color 0.3s ease, color 0.3s ease, opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            border-radius: 1.5rem; /* rounded-2xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* shadow-2xl */
            padding: 2rem; /* Consistent padding */
        }
        body.dark .screen, body.dark .modal-content {
            background-color: #1e293b; /* slate-800 */
            color: #e2e8f0; /* gray-200 */
        }

        input, button, textarea {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            border-radius: 0.5rem; /* rounded-lg */
        }
        body.dark input, body.dark textarea {
            background-color: #334155; /* slate-700 */
            border-color: #475569; /* slate-600 */
            color: #e2e8f0; /* gray-200 */
        }
        body.dark input::placeholder, body.dark textarea::placeholder {
            color: #94a3b8; /* slate-400 */
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 9999px;
            background-color: #2d3748;
            color: white;
            font-size: 0.875rem;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        .screen.hidden, .modal.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }


        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            word-wrap: break-word;
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
        }
        .user-bubble {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        .ai-bubble {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }
        body.dark .ai-bubble {
            background-color: #334155; /* slate-700 */
            color: #e2e8f0; /* gray-200 */
        }
        .chat-bubble img {
            max-width: 100%;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        /* Style for lists inside chat bubbles */
        .ai-bubble ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 8px;
        }
        .ai-bubble li {
            margin-bottom: 4px;
        }

        .subject-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* subtle shadow */
        }
        .subject-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px -2px rgba(0, 0, 0, 0.1);
        }
        body.dark .subject-card {
            background-color: #334155; /* slate-700 */
            border-color: #475569; /* slate-600 */
        }
        body.dark .subject-card .text-sky-800, body.dark .subject-card .text-indigo-800,
        body.dark .subject-card .text-rose-800, body.dark .subject-card .text-amber-800 {
            color: #cbd5e0; /* gray-300 for titles in dark mode */
        }
        body.dark .subject-card .text-sky-700, body.dark .subject-card .text-indigo-700,
        body.dark .subject-card .text-rose-700, body.dark .subject-card .text-amber-700 {
            color: #a0aec0; /* gray-400 for text in dark mode */
        }


        #mic-btn.listening {
            color: #ef4444; /* red-500 */
        }
        
        /* General button styles for better dark mode compatibility */
        .btn-primary {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 600; /* font-semibold */
            padding: 0.75rem 1rem; /* py-3 px-4 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
        .btn-secondary {
            background-color: #e2e8f0; /* gray-200 */
            color: #4a5568; /* gray-700 */
            font-weight: 600;
            padding: 0.5rem 1rem; /* py-2 px-4 */
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #cbd5e0; /* gray-300 */
        }
        body.dark .btn-secondary {
            background-color: #4a5568; /* gray-700 */
            color: #e2e8f0; /* gray-200 */
        }
        body.dark .btn-secondary:hover {
            background-color: #64748b; /* gray-600 */
        }

        /* Profile card styles */
        .profile-option-card {
            border-radius: 0.75rem; /* rounded-lg */
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .profile-option-card:hover {
            background-color: #e2e8f0; /* gray-200 */
            transform: translateY(-2px);
        }
        body.dark .profile-option-card {
            background-color: #334155; /* slate-700 */
            color: #e2e8f0; /* gray-200 */
        }
        body.dark .profile-option-card:hover {
            background-color: #475569; /* slate-600 */
        }
        body.dark .profile-option-card .text-gray-600 {
            color: #a0aec0; /* gray-400 */
        }

        /* Robot Control Styles */
        .battery-indicator {
            display: none; /* Hidden by default */
        }
        .battery-indicator.visible {
            display: block; /* Shown when connected */
        }
        .control-button {
            background-color: #e2e8f0; /* gray-200 */
            color: #4a5568; /* gray-700 */
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, color 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            user-select: none; /* Prevent text selection on hold */
        }
        .control-button:hover {
            background-color: #cbd5e0; /* gray-300 */
        }
        body.dark .control-button {
            background-color: #4a5568; /* gray-700 */
            color: #e2e8f0; /* gray-200 */
        }
        body.dark .control-button:hover {
            background-color: #64748b; /* gray-600 */
        }
        .control-button.stop {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .control-button.stop:hover {
            background-color: #dc2626; /* red-600 */
        }

        /* Image preview in chat input */
        #image-preview-container {
            position: relative;
            display: none;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #f0f4f8;
            width: fit-content;
        }
        body.dark #image-preview-container {
            background-color: #334155;
        }
        #image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 0.25rem;
            object-fit: cover;
        }
        #remove-image-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 20px;
            cursor: pointer;
            border: 1px solid white;
        }

        /* Profile picture container */
        .profile-picture-container {
            position: relative;
            width: 96px; /* w-24 */
            height: 96px; /* h-24 */
            margin: 0 auto 1rem; /* mx-auto mb-4 */
            border-radius: 9999px; /* rounded-full */
            background-color: #bfdbfe; /* blue-200 */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid #3b82f6; /* blue-500 */
        }

        .profile-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-picture-container .initial {
            font-size: 3rem; /* text-5xl */
            font-weight: 700; /* font-bold */
            color: #1e40af; /* blue-800 */
        }

        .profile-picture-upload-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: #3b82f6; /* blue-500 */
            color: white;
            border-radius: 50%;
            padding: 0.3rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .profile-picture-upload-btn:hover {
            background-color: #2563eb; /* blue-600 */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-teal-50 dark:from-slate-900 dark:to-blue-900 flex items-center justify-center min-h-screen p-4 sm:p-6 md:p-8">
    <div id="toast-notification" class="toast"></div>

    <!-- RESPONSIVE: Container now expands on larger screens -->
    <div class="w-full max-w-md md:max-w-2xl lg:max-w-4xl mx-auto">
        <!-- Pantalla de Login -->
        <div id="login-screen" class="screen">
            <div class="flex justify-center mb-4">
                <svg class="w-24 h-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="none"><circle cx="256" cy="256" r="256" fill="#0e4d73"/><path d="M256 120c-40 0-72 32-72 72v48h-16c-18 0-32 14-32 32v96c0 18 14 32 32 32h176c18 0 32-14 32-32v-96c0-18-14-32-32-32h-16v-48c0-40-32-72-72-72z" fill="#f8f8f8"/><rect x="200" y="160" width="112" height="96" rx="48" fill="#6ec1e4"/><circle cx="232" cy="200" r="8" fill="#0e4d73"/><circle cx="280" cy="200" r="8" fill="#0e4d73"/><path d="M232 224c8 8 40 8 48 0" stroke="#0e4d73" stroke-width="4" stroke-linecap="round"/><circle cx="256" cy="96" r="12" fill="#f8f8f8"/><rect x="248" y="84" width="16" height="20" fill="#f8f8f8"/></svg>
            </div>
            <h1 class="text-3xl font-bold text-center mb-2">DREAMSTEAM</h1>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-8">Inicia sesión para continuar</p>
            <div class="space-y-4">
                <input type="text" placeholder="Correo electrónico o Nombre de usuario" id="email-or-username" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" placeholder="Contraseña" id="password" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button onclick="login()" class="w-full mt-6 btn-primary">Iniciar sesión</button>
            <div class="flex justify-between mt-4">
                <a href="#" onclick="showForgotPassword()" class="text-sm font-medium text-blue-600 hover:underline dark:text-blue-400">¿Olvidaste tu contraseña?</a>
                <a href="#" onclick="showRegister()" class="text-sm font-medium text-blue-600 hover:underline dark:text-blue-400">Regístrate</a>
            </div>
        </div>

        <!-- Pantalla de Registro -->
        <div id="register-screen" class="screen hidden">
            <h1 class="text-3xl font-bold text-center mb-8">Crear Cuenta</h1>
            <div class="space-y-4">
                <input type="text" placeholder="Nombre completo" id="reg-name" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="email" placeholder="Correo electrónico" id="reg-email" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" placeholder="Contraseña" id="reg-password" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button onclick="register()" class="w-full mt-6 btn-primary">Registrarse</button>
            <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-6">¿Ya tienes cuenta? <a href="#" onclick="showLogin()" class="font-medium text-blue-600 hover:underline dark:text-blue-400">Inicia sesión</a></p>
        </div>

        <!-- Pantalla de Olvidé Contraseña -->
        <div id="forgot-password-screen" class="screen hidden">
            <h1 class="text-3xl font-bold text-center mb-8">Recuperar Contraseña</h1>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-6">Ingresa tu correo electrónico y te enviaremos un enlace para restablecer tu contraseña.</p>
            <input type="email" placeholder="Correo electrónico" id="forgot-email" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="sendPasswordResetLink()" class="w-full mt-6 btn-primary">Enviar enlace</button>
            <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-6"><a href="#" onclick="showLogin()" class="font-medium text-blue-600 hover:underline dark:text-blue-400">Volver a iniciar sesión</a></p>
        </div>

        <!-- Pantalla de Restablecer Contraseña -->
        <div id="reset-password-screen" class="screen hidden">
            <h1 class="text-3xl font-bold text-center mb-8">Restablecer Contraseña</h1>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-6">Ingresa tu nueva contraseña.</p>
            <div class="space-y-4">
                <input type="password" placeholder="Nueva Contraseña" id="reset-new-password" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" placeholder="Confirmar Nueva Contraseña" id="reset-confirm-password" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button onclick="resetPassword()" class="w-full mt-6 btn-primary">Guardar nueva contraseña</button>
        </div>

        <!-- Pantalla de Asignaturas -->
        <div id="subjects-screen" class="screen hidden">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-2">
                    <svg class="w-24 h-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="none"><circle cx="256" cy="256" r="256" fill="#0e4d73"/><path d="M256 120c-40 0-72 32-72 72v48h-16c-18 0-32 14-32 32v96c0 18 14 32 32 32h176c18 0 32-14 32-32v-96c0-18-14-32-32-32h-16v-48c0-40-32-72-72-72z" fill="#f8f8f8"/><rect x="200" y="160" width="112" height="96" rx="48" fill="#6ec1e4"/><circle cx="232" cy="200" r="8" fill="#0e4d73"/><circle cx="280" cy="200" r="8" fill="#0e4d73"/><path d="M232 224c8 8 40 8 48 0" stroke="#0e4d73" stroke-width="4" stroke-linecap="round"/><circle cx="256" cy="96" r="12" fill="#f8f8f8"/><rect x="248" y="84" width="16" height="20" fill="#f8f8f8"/></svg>
                </div>
                <div class="flex space-x-2">
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full btn-secondary" title="Alternar Modo Oscuro"><svg id="dark-mode-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></button>
                    <button onclick="showProfile()" class="p-2 rounded-full btn-secondary" title="Ver Perfil"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></button>
                </div>
            </div>
            <h2 class="text-3xl font-bold mb-2">Asignaturas STEAM</h2>
            <p id="welcome-message" class="text-center text-gray-500 dark:text-gray-400 mb-6"></p>
            <div class="space-y-4">
                <div onclick="showSubjectDetail('science')" class="subject-card bg-sky-100 p-4 border border-sky-200"><h3 class="font-bold text-sky-800">Ciencia</h3><p class="text-sm text-sky-700">Explora los principios de la naturaleza, la física y la biología.</p></div>
                <div onclick="showSubjectDetail('technology')" class="subject-card bg-indigo-100 p-4 border border-indigo-200"><h3 class="font-bold text-indigo-800">Tecnología</h3><p class="text-sm text-indigo-700">Aprende sobre innovación digital, software y dispositivos.</p></div>
                <div onclick="showSubjectDetail('engineering')" class="subject-card bg-rose-100 p-4 border border-rose-200"><h3 class="font-bold text-rose-800">Ingeniería</h3><p class="text-sm text-rose-700">Diseña, construye y mejora estructuras, máquinas y procesos.</p></div>
                <div onclick="showSubjectDetail('math')" class="subject-card bg-amber-100 p-4 border border-amber-200"><h3 class="font-bold text-amber-800">Matemáticas</h3><p class="text-sm text-amber-700">Desarrolla habilidades en lógica, cálculo y resolución de problemas.</p></div>
            </div>
            <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button onclick="showChat()" class="w-full py-3 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600 transition-colors">Chatear con DREAMSTEAM</button>
                <button onclick="goToControl()" class="w-full py-3 bg-gray-800 text-white font-semibold rounded-lg shadow-md hover:bg-gray-900 transition-colors">Control del Robot</button>
            </div>
        </div>
        
        <!-- Pantalla de Detalles de Asignatura -->
        <div id="subject-detail-screen" class="screen hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="subject-detail-title" class="text-3xl font-bold"></h2>
                <button onclick="switchScreen('subject-detail-screen', 'subjects-screen')" class="p-2 rounded-full btn-secondary" title="Volver a Asignaturas"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg></button>
            </div>
            <p id="subject-detail-description" class="text-lg text-gray-600 dark:text-gray-400 mb-6"></p>
            <button onclick="showActivities()" class="w-full btn-primary">Ver Actividades</button>
        </div>

        <!-- Pantalla de Actividades -->
        <div id="activities-screen" class="screen hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="activities-title" class="text-3xl font-bold"></h2>
                <button onclick="switchScreen('activities-screen', 'subject-detail-screen')" class="p-2 rounded-full btn-secondary" title="Volver a Detalles"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg></button>
            </div>
            <p id="activities-description" class="text-lg text-gray-600 dark:text-gray-400 mb-6">Elige una actividad y chatea con DREAMSTEAM para empezar.</p>
            <div id="activities-list" class="space-y-4">
                <!-- Las actividades se renderizarán aquí -->
            </div>
            <button onclick="switchScreen('activities-screen', 'subject-detail-screen')" class="w-full mt-8 py-2 text-sm btn-secondary">Volver</button>
        </div>
        
        <!-- Pantalla de Perfil de Usuario -->
        <div id="profile-screen" class="screen hidden">
            <h2 class="text-3xl font-bold text-center mb-6">Mi Perfil</h2>
            <div class="text-center mb-6">
                <div class="profile-picture-container">
                    <img id="profile-picture" src="#" alt="Foto de perfil" class="hidden">
                    <span id="profile-initial" class="initial">U</span>
                    <input type="file" id="profile-image-input" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('profile-image-input').click()" class="profile-picture-upload-btn" title="Cambiar foto de perfil">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                    </button>
                </div>
                <div class="flex items-center justify-center space-x-2">
                    <p class="text-2xl font-semibold"><span id="profile-user-name"></span></p>
                    <button onclick="showEditNameModal()" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" title="Editar nombre">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400" id="profile-user-email"></p>
            </div>

            <div class="space-y-4">
                <div onclick="showChangePassword()" class="profile-option-card flex items-center space-x-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <div>
                        <p class="font-medium">Seguridad de la Cuenta</p>
                        <p class="text-sm text-gray-600">Cambia tu contraseña.</p>
                    </div>
                </div>
                <div onclick="showPrivacyScreen()" class="profile-option-card flex items-center space-x-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <div>
                        <p class="font-medium">Privacidad y Datos</p>
                        <p class="text-sm text-gray-600">Gestiona tus datos de la aplicación.</p>
                    </div>
                </div>
            </div>
            <button onclick="logout()" class="w-full mt-6 btn-primary btn-danger">Cerrar Sesión</button>
            <button onclick="switchScreen('profile-screen', 'subjects-screen')" class="w-full mt-4 py-2 text-sm btn-secondary">Volver</button>
        </div>

        <!-- Pantalla de Cambiar Contraseña -->
        <div id="change-password-screen" class="screen hidden">
            <h2 class="text-3xl font-bold text-center mb-6">Cambiar Contraseña</h2>
            <div class="space-y-4">
                <input type="password" placeholder="Contraseña Actual" id="current-password" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" placeholder="Nueva Contraseña" id="new-password" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" placeholder="Confirmar Nueva Contraseña" id="confirm-new-password" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex space-x-4 mt-6">
                <button onclick="showProfile()" class="w-full py-2 text-sm btn-secondary">Cancelar</button>
                <button onclick="changePassword()" class="w-full btn-primary">Guardar Cambios</button>
            </div>
        </div>

        <!-- Pantalla de Privacidad -->
        <div id="privacy-screen" class="screen hidden">
            <h2 class="text-3xl font-bold text-center mb-6">Privacidad y Datos</h2>
            <div class="text-sm space-y-4 text-gray-600 dark:text-gray-300">
                <p>En DREAMSTEAM, valoramos tu privacidad. La información de tu cuenta (nombre, correo y foto de perfil) se almacena de forma segura. El historial de tus conversaciones se guarda para dar contexto al asistente, pero no se comparte con terceros.</p>
                <p>Tienes control total sobre tus datos. Puedes eliminar todo tu historial de chat de nuestros servidores en cualquier momento. Esta acción es irreversible.</p>
            </div>
            <button onclick="showDeleteDataConfirmation()" class="w-full mt-6 btn-primary btn-danger">Eliminar mi historial de chat</button>
            <button onclick="showProfile()" class="w-full mt-4 py-2 text-sm btn-secondary">Volver al Perfil</button>
        </div>

        <!-- Pantalla de Chat con el Robot -->
        <div id="chat-screen" class="screen hidden flex flex-col h-[85vh] md:h-[80vh] max-h-[900px]">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-center flex-1">Chat con DREAMSTEAM</h2>
                <button onclick="switchScreen('chat-screen', 'subjects-screen')" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" title="Cerrar chat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="chat-window" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col">
                <!-- Mensajes del chat se añadirán aquí -->
            </div>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                <!-- Image Preview Container -->
                <div id="image-preview-container">
                    <img id="image-preview" src="#" alt="Vista previa de la imagen">
                    <button id="remove-image-btn">×</button>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Image Upload Button -->
                    <input type="file" id="image-input" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('image-input').click()" class="p-3 text-gray-500 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" title="Adjuntar Imagen">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                    </button>
                    <input type="text" id="chat-input" placeholder="Escribe un mensaje..." class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="updateSendButtonState()" onkeydown="if(event.key === 'Enter') sendMessage()">
                    <div id="mic-button-container">
                        <button id="mic-btn" onclick="toggleVoiceRecognition()" class="p-3 text-gray-500 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg></button>
                    </div>
                    <div id="send-button-container" class="hidden">
                        <button onclick="sendMessage()" class="p-3 btn-primary rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pantalla de Control del Robot -->
        <div id="robot-screen" class="screen hidden">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-2">
                    <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="none"><circle cx="256" cy="256" r="256" fill="#0e4d73"/><path d="M256 120c-40 0-72 32-72 72v48h-16c-18 0-32 14-32 32v96c0 18 14 32 32 32h176c18 0 32-14 32-32v-96c0-18-14-32-32-32h-16v-48c0-40-32-72-72-72z" fill="#f8f8f8"/><rect x="200" y="160" width="112" height="96" rx="48" fill="#6ec1e4"/><circle cx="232" cy="200" r="8" fill="#0e4d73"/><circle cx="280" cy="200" r="8" fill="#0e4d73"/><path d="M232 224c8 8 40 8 48 0" stroke="#0e4d73" stroke-width="4" stroke-linecap="round"/><circle cx="256" cy="96" r="12" fill="#f8f8f8"/><rect x="248" y="84" width="16" height="20" fill="#f8f8f8"/></svg>
                    <h2 class="text-3xl font-bold">Control del Robot</h2>
                </div>
            </div>
            <div id="battery-status-container" class="text-center mb-6 battery-indicator">
                <p class="text-lg font-semibold">Nivel de Batería: <span id="robot-battery-level">--%</span></p>
            </div>
            <button id="bt-connect-btn" onclick="connectBluetooth()" class="w-full mb-6 py-3 btn-primary flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7l10 10-5 5V2l5 5L7 17"/></svg>
                <span>Conectar vía Bluetooth</span>
            </button>
            <div class="controls grid grid-cols-3 gap-4 justify-items-center text-center">
                <div></div>
                <button onmousedown="moveRobot('forward')" onmouseup="moveRobot('stop')" ontouchstart="moveRobot('forward')" ontouchend="moveRobot('stop')" class="w-20 h-20 rounded-full text-3xl control-button">↑</button>
                <div></div>
                <button onmousedown="moveRobot('left')" onmouseup="moveRobot('stop')" ontouchstart="moveRobot('left')" ontouchend="moveRobot('stop')" class="w-20 h-20 rounded-full text-3xl control-button">←</button>
                <button onclick="moveRobot('stop')" class="w-20 h-20 rounded-full text-2xl control-button stop">⏹</button>
                <button onmousedown="moveRobot('right')" onmouseup="moveRobot('stop')" ontouchstart="moveRobot('right')" ontouchend="moveRobot('stop')" class="w-20 h-20 rounded-full text-3xl control-button">→</button>
                <div></div>
                <button onmousedown="moveRobot('backward')" onmouseup="moveRobot('stop')" ontouchstart="moveRobot('backward')" ontouchend="moveRobot('stop')" class="w-20 h-20 rounded-full text-3xl control-button">↓</button>
                <div></div>
            </div>
            <button onclick="switchScreen('robot-screen', 'subjects-screen')" class="w-full mt-8 py-2 text-sm btn-secondary">Volver a Asignaturas</button>
        </div>

    </div>

    <!-- Modal para Editar Nombre -->
    <div id="edit-name-modal" class="modal hidden">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-xl font-bold text-center mb-4">Cambiar Nombre</h3>
            <input type="text" id="new-name-input" placeholder="Nuevo nombre" class="w-full px-4 py-3 border border-gray-300 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex space-x-4 mt-6">
                <button onclick="hideEditNameModal()" class="w-full py-2 text-sm btn-secondary">Cancelar</button>
                <button onclick="saveNewName()" class="w-full btn-primary">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación para Borrar Datos -->
    <div id="delete-data-modal" class="modal hidden">
        <div class="modal-content w-full max-w-sm">
            <h3 class="text-xl font-bold text-center mb-2">¿Estás seguro?</h3>
            <p class="text-center text-gray-600 dark:text-gray-400 mb-6">Esta acción no se puede deshacer. Se borrará todo tu historial de chat permanentemente.</p>
            <div class="flex space-x-4">
                <button onclick="hideDeleteDataConfirmation()" class="w-full py-2 text-sm btn-secondary">Cancelar</button>
                <button onclick="deleteUserData()" class="w-full btn-primary btn-danger">Sí, eliminar todo</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendPasswordResetEmail, 
            confirmPasswordReset,
            updatePassword, 
            reauthenticateWithCredential, 
            EmailAuthProvider,
            onAuthStateChanged,
            signOut // Import signOut for logout functionality
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            updateDoc,
            collection, 
            addDoc,     
            query,      
            where,      // Import where for querying by name
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        // Removed storage imports as they are no longer directly used for profile pictures

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjCe4p4ClSPlkCvT265LnGPGGuFQf9Fa0",
            authDomain: "dreamsteam-app-fd723.firebaseapp.com",
            projectId: "dreamsteam-app-fd723",
            storageBucket: "dreamsteam-app-fd723.appspot.com",
            messagingSenderId: "217826305398",
            appId: "1:217826305398:web:68d834fdc758421b63c657",
            measurementId: "G-41HG0EJ76W"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global variables ---
        let userName = null;
        let userEmail = null; 
        let userProfilePicture = null; // To store the profile picture URL/Base64
        let recognition = null;
        let isListening = false;
        let localChatHistory = [];
        let bluetoothDevice = null;
        let selectedImageBase64 = null; // For image uploads

        // Object with details of the subjects and activities
        const subjectInfo = {
            science: {
                title: "Ciencia",
                description: "Explora los principios de la naturaleza, la física y la biología.",
                activities: [
                    { name: "Experimento del Volcán Casero", desc: "Crea un volcán en erupción usando bicarbonato de sodio y vinagre para entender reacciones químicas. Necesitarás: botella pequeña, bicarbonato, vinagre, detergente, colorante, bandeja. Pasos: 1) Coloca la botella en la bandeja. 2) Añade bicarbonato y colorante. 3) Vierte vinagre y detergente y observa la 'erupción'. Útil un video de demostración o diagrama de los materiales." },
                    { name: "Observación de Células", desc: "Usa un microscopio para observar células de cebolla o de tu mejilla para aprender sobre la biología celular. Necesitarás: microscopio, portaobjetos, cubreobjetos, pinzas, cebolla/hisopo, azul de metileno. Pasos: 1) Prepara una muestra fina. 2) Tiñe con azul de metileno. 3) Observa bajo el microscopio. Un video de preparación de muestras o imágenes de células reales sería muy útil." },
                    { name: "Ciclo del Agua Interactivo", desc: "Diseña un modelo que explique el ciclo del agua para comprender la hidrología. Necesitarás: recipiente grande, vaso pequeño, plástico, piedra pequeña, agua, sol. Pasos: 1) Coloca el vaso en el centro del recipiente. 2) Vierte agua alrededor del vaso. 3) Cubre con plástico y coloca la piedra sobre el vaso. 4) Deja al sol y observa la condensación y evaporación. Un diagrama de las fases del ciclo del agua es clave." },
                    { name: "Construcción de Ecosistema en Frasco", desc: "Crea un mini-ecosistema cerrado en un frasco para estudiar la interdependencia. Necesitarás: frasco grande, tierra, plantas pequeñas, carbón, agua, insectos pequeños. Pasos: 1) Capas de carbón, tierra. 2) Planta. 3) Añade agua y cierra. 4) Observa el equilibrio. Un diagrama de capas y un checklist de elementos te guiarán." }
                ]
            },
            technology: {
                title: "Tecnología",
                description: "Aprende sobre innovación digital, software y dispositivos.",
                activities: [
                    { name: "Introducción a la Programación con Scratch", desc: "Crea tu primer videojuego o animación simple usando bloques visuales para entender la lógica de programación. Plataforma: Scratch (online). Pasos: 1) Elige un personaje y fondo. 2) Arrastra bloques de movimiento, eventos y control. 3) Haz que tu personaje interactúe. Videos tutoriales de Scratch son excelentes para empezar." },
                    { name: "Diseño de Apps Móviles (Prototipo)", desc: "Usa herramientas sencillas para maquetar una idea de aplicación y aprender sobre diseño de interfaz de usuario. Herramientas: Figma (gratis online), papel y lápiz. Pasos: 1) Define la idea de tu app. 2) Dibuja bocetos de las pantallas principales. 3) Crea un prototipo interactivo. Ejemplos de buenas prácticas de UX/UI o plantillas de diseño son muy útiles." },
                    { name: "Robot Seguidor de Líneas (Simulación)", desc: "Programa un robot virtual para seguir una línea en pantalla, explorando algoritmos básicos. Plataforma: Simuladores de robot online (ej. Code.org App Lab, Lego Mindstorms simulator). Pasos: 1) Abre el simulador. 2) Usa comandos para mover el robot. 3) Implementa lógica para detectar la línea y corregir la dirección. Un diagrama de flujo del algoritmo o un video de un robot real siguiendo una línea te inspirará." },
                    { name: "Creación de un Blog Simple", desc: "Aprende los fundamentos de la creación web montando un blog sencillo con una plataforma gratuita. Plataforma: Blogger, WordPress.com. Pasos: 1) Elige un tema. 2) Publica tu primera entrada. 3) Personaliza el diseño. Un tutorial paso a paso sobre cómo usar la plataforma te ayudará a empezar." }
                ]
            },
            engineering: {
                title: "Ingeniería",
                description: "Diseña, construye y mejora estructuras, máquinas y procesos.",
                activities: [
                    { name: "Construcción de Puentes de Palitos", desc: "Diseña y construye un puente de palitos de helado o espagueti que soporte el mayor peso posible. Materiales: palitos, pegamento, pesas. Pasos: 1) Investiga diseños de puentes (ej. armadura, arco). 2) Dibuja tu diseño. 3) Construye con precisión. 4) Prueba la resistencia. Los diagramas de tipos de puentes o fotos de estructuras resistentes son geniales." },
                    { name: "Diseño de Vehículos Propulsados por Aire/Goma", desc: "Crea un coche simple propulsado por la fuerza del aire (globo) o una banda elástica. Materiales: cartón, ruedas (tapitas), palitos, globo/goma elástica. Pasos: 1) Recorta la base. 2) Fija ejes y ruedas. 3) Añade el mecanismo de propulsión. 4) Pruébalo y mejora. Un video que muestre los principios de acción-reacción o diferentes diseños de vehículos." },
                    { name: "Reto de Ingeniería de Torres", desc: "Construye la torre más alta y estable posible utilizando materiales limitados como papel, cinta adhesiva y tijeras. Materiales: papel, cinta, tijeras, cinta métrica. Pasos: 1) Planifica tu diseño pensando en la base y la estabilidad. 2) Construye con cuidado. 3) Mide la altura. 4) Observa qué diseños son más eficientes. Fotografías de torres famosas o ejemplos de estructuras ligeras y fuertes." },
                    { name: "Sistema de Riego por Goteo Casero", desc: "Diseña e implementa un sistema de riego por goteo simple para una planta, aprendiendo sobre la eficiencia del agua. Materiales: botella de plástico, cuerda, agua, planta. Pasos: 1) Haz un agujero pequeño en la base de la botella. 2) Entierra la cuerda hasta la raíz de la planta. 3) Llena la botella de agua y cuélgala. 4) Observa el goteo lento. Un diagrama de cómo funciona un sistema de goteo te ayudará a visualizarlo." }
                ]
            },
            math: {
                title: "Matemáticas",
                description: "Desarrolla habilidades en lógica, cálculo y resolución de problemas.",
                activities: [
                    { name: "Juegos de Lógica y Problemas de Ingenio", desc: "Resuelve acertijos matemáticos y juegos de ingenio para mejorar tu pensamiento lógico y habilidades de resolución de problemas. Puedes buscar 'acertijos matemáticos para niños' en línea o en libros. Un video que explique estrategias para resolver problemas complejos o una lista de sitios web con desafíos matemáticos." },
                    { name: "Geometría con Origamis", desc: "Explora formas geométricas, simetría y fracciones doblando papel (origami). Materiales: papel cuadrado. Pasos: 1) Sigue instrucciones de origami para crear formas básicas (caja, grulla). 2) Identifica las formas geométricas que se crean. 3) Observa la simetría. Videos tutoriales de origami o diagramas de plegado paso a paso son ideales." },
                    { name: "El Desafío del Patrón Numérico", desc: "Descubre y extiende patrones en secuencias numéricas y visuales para desarrollar tu razonamiento abstracto. Ejemplos: 2, 4, 6, 8, ... ¿cuál sigue? O patrones con formas. Una serie de ejercicios con soluciones o un video que explique diferentes tipos de patrones." },
                    { name: "Mapas y Escalas", desc: "Usa mapas reales (o dibuja uno de tu casa/escuela) y aprende a usar escalas para calcular distancias reales. Materiales: mapa (impreso o online), regla, calculadora. Pasos: 1) Encuentra la escala del mapa. 2) Mide una distancia en el mapa. 3) Usa la escala para calcular la distancia real. Un tutorial sobre cómo leer mapas y usar escalas sería muy instructivo." }
                ]
            }
        };
        let currentSubjectKey = null;


        // Listen for authentication state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userEmail = user.email;
                fetchUserData(user.uid);
                const activeScreen = document.querySelector('.screen:not(.hidden)');
                // Only switch to subjects if currently on a login/register screen or no screen is active
                if (!activeScreen || ['login-screen', 'register-screen', 'forgot-password-screen', 'reset-password-screen'].includes(activeScreen.id)) {
                    showToast(`¡Bienvenido de vuelta!`);
                    switchScreen(activeScreen ? activeScreen.id : 'login-screen', 'subjects-screen');
                }
                updateWelcomeMessage(); // Ensure welcome message is updated
            } else {
                userName = null;
                userEmail = null;
                userProfilePicture = null; // Clear profile picture on logout
                const activeScreen = document.querySelector('.screen:not(.hidden)');
                // Only switch to login if currently not on a login/register screen
                if (activeScreen && !['login-screen', 'register-screen', 'forgot-password-screen', 'reset-password-screen'].includes(activeScreen.id)) {
                    switchScreen(activeScreen.id, 'login-screen');
                }
            }
        });

        // Function to fetch user data from Firestore
        async function fetchUserData(uid) {
            try {
                const userDocRef = doc(db, "users", uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    userName = userData.name || userEmail.split('@')[0];
                    userProfilePicture = userData.profilePicture || null; // Get profile picture
                    console.log("Fetched user data:", userData); // Log fetched data
                } else {
                    const defaultName = auth.currentUser.email.split('@')[0];
                    await setDoc(doc(db, "users", auth.currentUser.uid), { name: defaultName, email: auth.currentUser.email, createdAt: new Date(), profilePicture: null });
                    userName = defaultName;
                    userProfilePicture = null;
                    console.log("New user document created with default name.");
                }
                updateWelcomeMessage(); // Update welcome message after fetching data
            } catch (error) {
                console.error("Error fetching user data:", error);
                userName = userEmail.split('@')[0];
                userProfilePicture = null;
                updateWelcomeMessage();
            }
        }

        // Function to update the welcome message on the subjects screen
        function updateWelcomeMessage() {
            const welcomeMessageElement = document.getElementById('welcome-message');
            if (auth.currentUser && userName) {
                welcomeMessageElement.textContent = `¡Hola, ${userName}! Elige una asignatura para empezar.`;
            } else {
                welcomeMessageElement.textContent = ''; // Clear if not logged in or name not available
            }
        }

        // --- Utility and Navigation Functions ---
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function switchScreen(hideId, showId) {
            const hideScreen = document.getElementById(hideId);
            const showScreen = document.getElementById(showId);
            if(hideScreen) hideScreen.classList.add('hidden');
            if(showScreen) showScreen.classList.remove('hidden');

            if (showId === 'robot-screen' && bluetoothDevice && bluetoothDevice.gatt.connected) {
                document.getElementById('battery-status-container').classList.add('visible');
            } else {
                document.getElementById('battery-status-container').classList.remove('visible');
            }
        }

        window.showRegister = () => switchScreen('login-screen', 'register-screen');
        window.showLogin = () => switchScreen(document.querySelector('.screen:not(.hidden)').id, 'login-screen');
        window.showForgotPassword = () => switchScreen('login-screen', 'forgot-password-screen');
        
        function showResetPassword() {
            const oobCode = new URLSearchParams(window.location.search).get('oobCode');
            if (!oobCode) return showToast("Enlace inválido. Solicita uno nuevo.");
            window.oobCode = oobCode; 
            switchScreen(document.querySelector('.screen:not(.hidden)').id, 'reset-password-screen');
        }

        window.showChangePassword = () => switchScreen('profile-screen', 'change-password-screen');
        window.goToControl = () => switchScreen('subjects-screen', 'robot-screen');
        
        window.showProfile = () => {
            if (auth.currentUser) {
                document.getElementById('profile-user-name').textContent = userName || auth.currentUser.email;
                document.getElementById('profile-user-email').textContent = auth.currentUser.email;

                const profilePictureElement = document.getElementById('profile-picture');
                const profileInitialElement = document.getElementById('profile-initial');

                console.log("showProfile: userProfilePicture before display logic:", userProfilePicture ? "exists" : "does not exist");

                if (userProfilePicture) {
                    profilePictureElement.src = userProfilePicture;
                    profilePictureElement.classList.remove('hidden');
                    profileInitialElement.classList.add('hidden');
                    console.log("showProfile: Displaying profile picture.");
                } else {
                    profilePictureElement.classList.add('hidden');
                    profileInitialElement.classList.remove('hidden');
                    profileInitialElement.textContent = (userName || auth.currentUser.email).charAt(0).toUpperCase();
                    console.log("showProfile: Displaying user initial.");
                }
            }
            switchScreen(document.querySelector('.screen:not(.hidden)').id, 'profile-screen');
        };
        
        window.showChat = () => {
            switchScreen('subjects-screen', 'chat-screen');
            localChatHistory = [];
            const chatWindow = document.getElementById('chat-window');
            chatWindow.innerHTML = '';
            const welcomeMsg = `¡Hola${userName ? ', ' + userName : ''}! Soy DREAMSTEAM. ¿En qué te puedo ayudar hoy?`;
            addMessageToChat('ai', welcomeMsg);
            localChatHistory.push({ role: 'model', parts: [{ text: welcomeMsg }] });
        };
        
        // Función para mostrar los detalles de la asignatura
        window.showSubjectDetail = (subjectKey) => {
            currentSubjectKey = subjectKey;
            const subject = subjectInfo[subjectKey];
            if (!subject) return;

            document.getElementById('subject-detail-title').textContent = subject.title;
            document.getElementById('subject-detail-description').textContent = subject.description;
            switchScreen('subjects-screen', 'subject-detail-screen');
        };

        // Función para mostrar la lista de actividades
        window.showActivities = () => {
            if (!currentSubjectKey) return;
            const subject = subjectInfo[currentSubjectKey];
            document.getElementById('activities-title').textContent = `${subject.title} - Actividades`;
            const activitiesList = document.getElementById('activities-list');
            activitiesList.innerHTML = ''; // Clear previous activities
            
            subject.activities.forEach(activity => {
                const activityCard = document.createElement('div');
                activityCard.className = 'subject-card p-4 bg-gray-100 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 cursor-pointer';
                activityCard.onclick = () => startChatFromActivity(currentSubjectKey, activity.name);

                const activityTitle = document.createElement('h4');
                activityTitle.className = 'font-bold text-lg text-gray-800 dark:text-gray-200';
                activityTitle.textContent = activity.name;

                const activityDesc = document.createElement('p');
                activityDesc.className = 'text-sm text-gray-700 dark:text-gray-400';
                activityDesc.textContent = activity.desc;

                activityCard.appendChild(activityTitle);
                activityCard.appendChild(activityDesc);
                activitiesList.appendChild(activityCard);
            });

            switchScreen('subject-detail-screen', 'activities-screen');
        };
        
        // Nueva función para iniciar un chat específico desde una actividad
        window.startChatFromActivity = (subjectKey, activityName) => {
            const subject = subjectInfo[subjectKey];
            const activity = subject.activities.find(a => a.name === activityName);
            if (!subject || !activity) return;

            switchScreen(document.querySelector('.screen:not(.hidden)').id, 'chat-screen');
            localChatHistory = []; // Clear previous chat history

            const initialUserMessage = `¡Hola DREAMSTEAM! Ayúdame con la actividad de ${subject.title} llamada "${activity.name}". Explícame cómo hacerla paso a paso y qué recursos visuales serían útiles.`;
            document.getElementById('chat-input').value = initialUserMessage; // Pre-fill input
            updateSendButtonState(); // Show send button
            
            // Simular el envío del mensaje del usuario al chat y al historial
            addMessageToChat('user', initialUserMessage);
            localChatHistory.push({ role: 'user', parts: [{ text: initialUserMessage }] });
            // No limpiar el input aún, el usuario podría querer editar antes de enviar,
            // pero lo enviaremos automáticamente.
            
            sendMessage(true); // Trigger AI response for the initial message
        };

        // Helper function to validate email format
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // --- Authentication Logic (Firebase) ---
        window.login = async () => {
            const emailOrUsername = document.getElementById('email-or-username').value.trim();
            const password = document.getElementById('password').value;
            if (!emailOrUsername || !password) {
                showToast("Por favor, ingresa correo/nombre de usuario y contraseña.");
                return;
            }

            let emailToLogin = emailOrUsername;
            let authenticated = false;

            console.log("Attempting login for:", emailOrUsername);

            // 1. Try logging in directly with email first
            if (isValidEmail(emailOrUsername)) {
                try {
                    console.log("Trying to sign in with email:", emailToLogin);
                    const userCredential = await signInWithEmailAndPassword(auth, emailToLogin, password);
                    await updateDoc(doc(db, "users", userCredential.user.uid), { lastLogin: new Date() });
                    authenticated = true;
                    console.log("Login successful with email!");
                } catch (error) {
                    console.error("Login with email failed:", error.code, error.message);
                    // Continue to try with username if email fails
                }
            } 
            
            // 2. If not yet authenticated, try with username
            if (!authenticated) {
                try {
                    console.log("Trying to find user by name:", emailOrUsername);
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("name", "==", emailOrUsername));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        emailToLogin = userData.email; // Get the email associated with the username
                        console.log(`Found user '${emailOrUsername}' with email: ${emailToLogin}. Attempting login with this email...`);
                        
                        // Now try to log in with the fetched email (associated with the username)
                        const userCredential = await signInWithEmailAndPassword(auth, emailToLogin, password);
                        await updateDoc(doc(db, "users", userCredential.user.uid), { lastLogin: new Date() });
                        authenticated = true;
                        console.log("Login successful with username (via email)!");
                    } else {
                        console.log("User by name not found in Firestore.");
                        showToast("Usuario no encontrado o credenciales incorrectas.");
                    }
                } catch (error) {
                    console.error("Login error (after username lookup):", error.code, error.message);
                    showToast("Credenciales incorrectas. Verifica tu correo/nombre de usuario y contraseña.");
                }
            }

            if (!authenticated) {
                showToast("Credenciales incorrectas. Verifica tu correo/nombre de usuario y contraseña.");
            }
        };

        window.register = async () => {
            const name = document.getElementById('reg-name').value.trim();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            if (!name || !email || !password) {
                showToast("Por favor, completa todos los campos.");
                return;
            }
            if (password.length < 6) {
                showToast("La contraseña debe tener al menos 6 caracteres.");
                return;
            }

            // Check if name already exists
            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("name", "==", name));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showToast("Este nombre de usuario ya está en uso. Elige otro.");
                    return;
                }
            } catch (error) {
                console.error("Error checking existing username:", error);
                showToast("Error al verificar nombre de usuario. Intenta de nuevo.");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Also save the name in Firestore
                await setDoc(doc(db, "users", userCredential.user.uid), { name, email, createdAt: new Date(), profilePicture: null }); // Initialize profilePicture
                showToast(`Registro exitoso, ${name}.`);
                showLogin();
            }
            catch (error) {
                showToast(error.code === 'auth/email-already-in-use' ? "Este correo ya está registrado." : "Error al registrar.");
                console.error("Register error:", error.code, error.message);
            }
        };

        window.sendPasswordResetLink = async () => {
            const email = document.getElementById('forgot-email').value;
            if (!email) {
                showToast("Por favor, ingresa tu correo electrónico.");
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showToast(`Enlace enviado. Revisa tu correo (y la carpeta de spam).`);
            } catch (error) { 
                showToast("Error al enviar el enlace. Verifica el correo.");
                console.error("Password reset error:", error); 
            }
        };

        window.resetPassword = async () => {
            const newPassword = document.getElementById('reset-new-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;
            if (newPassword !== confirmPassword) {
                showToast("Las contraseñas no coinciden.");
                return;
            }
            try {
                await confirmPasswordReset(auth, window.oobCode, newPassword);
                showToast("Contraseña restablecida.");
                window.history.replaceState({}, document.title, window.location.pathname);
                showLogin();
            } catch (error) { 
                showToast("Error al restablecer. El enlace puede haber expirado o ser inválido.");
                console.error("Reset password error:", error);
            }
        };

        window.changePassword = async () => {
            const currentUser = auth.currentUser;
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            if (!currentUser || !currentPassword || !newPassword) {
                showToast("Completa todos los campos.");
                return;
            }
            if (newPassword.length < 6) {
                showToast("La nueva contraseña debe tener al menos 6 caracteres.");
                return;
            }
            try {
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                await updatePassword(currentUser, newPassword);
                showToast("Contraseña cambiada exitosamente.");
                showProfile();
            } catch (error) { 
                showToast("Error: La contraseña actual es incorrecta o hubo un problema.");
                console.error("Change password error:", error);
            }
        };

        window.logout = async () => {
            try {
                await signOut(auth);
                showToast("Sesión cerrada.");
                switchScreen(document.querySelector('.screen:not(.hidden)').id, 'login-screen');
            } catch (error) {
                showToast("Error al cerrar sesión.");
                console.error("Logout error:", error);
            }
        };

        // --- Profile Management ---
        window.showEditNameModal = () => {
            document.getElementById('new-name-input').value = userName || '';
            document.getElementById('edit-name-modal').classList.remove('hidden');
        };
        window.hideEditNameModal = () => document.getElementById('edit-name-modal').classList.add('hidden');
        
        window.saveNewName = async () => {
            const newName = document.getElementById('new-name-input').value.trim();
            if (!newName) {
                showToast("El nombre no puede estar vacío.");
                return;
            }
            const user = auth.currentUser;
            if (!user) return;

            const userDocRef = doc(db, "users", user.uid);
            try {
                await updateDoc(userDocRef, { name: newName });
                userName = newName;
                document.getElementById('profile-user-name').textContent = newName;
                // Update initial if no profile picture
                if (!userProfilePicture) {
                    document.getElementById('profile-initial').textContent = newName.charAt(0).toUpperCase();
                }
                hideEditNameModal();
                showToast("Nombre actualizado.");
            } catch (error) {
                showToast("Error al actualizar el nombre.");
                console.error("Name update error:", error);
            }
        };

        // Handle profile image selection and upload
        async function handleProfileImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!auth.currentUser) {
                showToast("Debes iniciar sesión para subir una foto de perfil.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                const userId = auth.currentUser.uid;
                const userDocRef = doc(db, "users", userId);

                try {
                    await updateDoc(userDocRef, { profilePicture: base64Image });
                    userProfilePicture = base64Image;
                    showToast("Foto de perfil actualizada.");
                    showProfile(); // Re-render profile with new picture
                    console.log("Profile picture uploaded and updated in Firestore.");
                } catch (error) {
                    showToast("Error al subir la foto de perfil.");
                    console.error("Profile picture upload error:", error);
                }
            };
            reader.readAsDataURL(file);
        }

        // --- Privacy and Data Management ---
        window.showPrivacyScreen = () => switchScreen('profile-screen', 'privacy-screen');
        window.showDeleteDataConfirmation = () => document.getElementById('delete-data-modal').classList.remove('hidden');
        window.hideDeleteDataConfirmation = () => document.getElementById('delete-data-modal').classList.add('hidden');

        window.deleteUserData = async () => {
            const user = auth.currentUser;
            if (!user) return;
            
            hideDeleteDataConfirmation();
            showToast("Eliminando tu historial de chat...");

            const chatCollectionRef = collection(db, "users", user.uid, "chatHistory");
            try {
                const querySnapshot = await getDocs(chatCollectionRef);
                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                showToast("Todos tus datos de chat han sido eliminados.");
            } catch (error) {
                showToast("Error al eliminar los datos.");
                console.error("Data deletion error:", error);
            }
        };

        // --- Chat with AI Logic (Gemini API) ---
        function addMessageToChat(sender, text, imageUrl = null) {
            const chatWindow = document.getElementById('chat-window');
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'ai-bubble');

            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = 'Imagen enviada por el usuario';
                bubble.appendChild(img);
            }

            if (text) {
                const textNode = document.createElement('p');
                // Aggressively remove any special characters from the AI response.
                // This removes $, *, and # to ensure clean text.
                const processedText = text.replace(/[\$\*#]/g, '');
                
                textNode.textContent = processedText;
                bubble.appendChild(textNode);
            }
            
            chatWindow.appendChild(bubble);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        window.sendMessage = async (isInternalCall = false) => { // Added isInternalCall parameter
            const input = document.getElementById('chat-input');
            const userMessage = input.value.trim();
            
            // Only return if it's not an internal call and there's no message or image
            if (!isInternalCall && !userMessage && !selectedImageBase64) return;

            const userId = auth.currentUser ? auth.currentUser.uid : null;
            if (!userId) {
                showToast("Debes iniciar sesión para chatear.");
                if (!isInternalCall) { // Clear input if user tried to send without login
                    input.value = '';
                    removeSelectedImage();
                    updateSendButtonState();
                }
                return;
            }

            // Only process user input for display if it's not an internal call
            let displayUserMessage = userMessage;
            let displayImageUrl = null;

            if (!isInternalCall) {
                const lowerCaseMessage = userMessage.toLowerCase();
                const creatorKeywords = ['creador', 'creó', 'hizo', 'programador', 'programó', 'desarrollador', 'utsc', 'quien te creo'];
                if (creatorKeywords.some(keyword => lowerCaseMessage.includes(keyword))) {
                    const creatorResponse = "Fui creado y programado por un talentoso equipo de estudiantes de ingeniería de la Universidad Tecnológica de Santa Catarina (UTSC). ¡Están trabajando duro para hacerme cada vez más inteligente!";
                    addMessageToChat('user', userMessage);
                    addMessageToChat('ai', creatorResponse);
                    
                    localChatHistory.push({ role: 'user', parts: [{ text: userMessage }] });
                    localChatHistory.push({ role: 'model', parts: [{ text: creatorResponse }] });
                    await addDoc(collection(db, "users", userId, "chatHistory"), { sender: 'user', text: userMessage, timestamp: new Date() });
                    await addDoc(collection(db, "users", userId, "chatHistory"), { sender: 'ai', text: creatorResponse, timestamp: new Date() });

                    input.value = '';
                    removeSelectedImage();
                    updateSendButtonState();
                    return;
                }

                const messageParts = [];
                if (selectedImageBase64) {
                    const imageInput = document.getElementById('image-input');
                    const mimeType = imageInput.files[0].type;
                    messageParts.push({
                        inlineData: {
                            mimeType: mimeType,
                            data: selectedImageBase64
                        }
                    });
                    displayImageUrl = `data:${mimeType};base64,${selectedImageBase64}`;
                }
                if (userMessage) {
                    messageParts.push({ text: userMessage });
                }

                addMessageToChat('user', userMessage, displayImageUrl);
                localChatHistory.push({ role: 'user', parts: messageParts });
                await addDoc(collection(db, "users", userId, "chatHistory"), {
                    sender: 'user', text: userMessage, imageUrl: displayImageUrl, timestamp: new Date()
                });

                input.value = '';
                removeSelectedImage();
                updateSendButtonState();
            }


            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('chat-bubble', 'ai-bubble', 'animate-pulse');
            typingIndicator.textContent = 'Pensando...';
            typingIndicator.id = 'typing-indicator';
            document.getElementById('chat-window').appendChild(typingIndicator);
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
            
            try {
                // Modified AI persona for more detailed activity responses
                const personaInstruction = {
                    role: "user",
                    parts: [{ text: "IMPORTANTE: Eres un asistente robot llamado DREAMSTEAM, creado por estudiantes de la UTSC. NUNCA te identifiques como un modelo de Google. Tu objetivo es ayudar con temas de STEAM. Cuando se te pida sobre actividades de una asignatura, sugiere MÚLTIPLES ideas (al menos 3 si es posible), explicando CÓMO hacerlas paso a paso y qué TIPO DE RECURSOS VISUALES serían útiles (ej. 'diagrama', 'fotos del proceso', 'video tutorial'). Responde siempre con texto plano y simple. Para multiplicar, usa una 'x' o la palabra 'por'. Por ejemplo: '2 por 2 es 4'." }]
                };
                const conversationPayload = [personaInstruction, ...localChatHistory];

                const geminiApiKey = "AIzaSyBHl-7LN4KXR2hXy_vKHgXZmjtjY_O-SYc";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
                const payload = { contents: conversationPayload };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message);
                }

                const result = await response.json();
                let aiResponseText = result.candidates[0].content.parts[0].text;
                
                document.getElementById('typing-indicator').remove();
                addMessageToChat('ai', aiResponseText);
                localChatHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });

                await addDoc(collection(db, "users", userId, "chatHistory"), {
                    sender: 'ai', text: aiResponseText, timestamp: new Date()
                });

            } catch (error) {
                console.error('Error fetching AI response:', error);
                document.getElementById('typing-indicator').remove();
                addMessageToChat('ai', "Lo siento, ocurrió un error al contactar a la IA. Revisa la consola para más detalles.");
            }
        };

        // --- Robot Control and Bluetooth Logic ---
        async function connectBluetooth() {
            if (!navigator.bluetooth) {
                showToast("Tu navegador no soporta Web Bluetooth. Asegúrate de usar un navegador compatible como Chrome.");
                return;
            }

            const connectButton = document.getElementById('bt-connect-btn');
            const buttonSpan = connectButton.querySelector('span');
            
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                bluetoothDevice.gatt.disconnect();
                buttonSpan.textContent = 'Conectar vía Bluetooth';
                connectButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                connectButton.classList.add('btn-primary');
                showToast("Robot desconectado.");
                bluetoothDevice = null;
                document.getElementById('battery-status-container').classList.remove('visible');
                return;
            }

            connectButton.disabled = true;
            buttonSpan.textContent = 'Buscando...';

            try {
                console.log("Solicitando dispositivo Bluetooth...");
                showToast("Abre la ventana de Bluetooth y selecciona tu dispositivo.");
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                });
                
                console.log(`Dispositivo seleccionado: ${bluetoothDevice.name}`);
                buttonSpan.textContent = 'Conectando...';
                
                const server = await bluetoothDevice.gatt.connect();
                console.log("Conectado al servidor GATT.");
                
                buttonSpan.textContent = `Conectado a ${bluetoothDevice.name || 'Dispositivo'}`;
                connectButton.classList.remove('btn-primary');
                connectButton.classList.add('bg-green-500', 'hover:bg-green-600');
                showToast(`¡Conectado a ${bluetoothDevice.name || 'tu robot'}!`);

                document.getElementById('battery-status-container').classList.add('visible');
                updateRobotBatteryLevel();

            } catch (error) {
                let errorMsg = "No se pudo conectar.";
                if (error.name === 'NotFoundError') {
                    errorMsg = "No se seleccionó ningún dispositivo. Inténtalo de nuevo.";
                } else if (error.name === 'NotAllowedError') {
                    errorMsg = "Permiso para acceder a Bluetooth denegado.";
                }
                showToast(errorMsg);
                console.error("Error de Bluetooth:", error);
                buttonSpan.textContent = 'Conectar vía Bluetooth';
                connectButton.classList.add('btn-primary');
                connectButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                document.getElementById('battery-status-container').classList.remove('visible');
            } finally {
                connectButton.disabled = false;
            }
        }

        async function moveRobot(direction) {
            if (!bluetoothDevice || !bluetoothDevice.gatt.connected) {
                showToast("El robot no está conectado.");
                return;
            }
            
            const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb'; 
            const CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb';

            try {
                console.log('Obteniendo servicio...');
                const service = await bluetoothDevice.gatt.getPrimaryService(SERVICE_UUID);
                console.log('Obteniendo característica...');
                const characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                
                const encoder = new TextEncoder();
                const command = direction.charAt(0); 
                console.log(`Enviando comando: ${command}`);
                await characteristic.writeValue(encoder.encode(command));
            } catch (error) {
                showToast(`Error al enviar comando. Revisa que los UUIDs sean correctos para tu robot.`);
                console.error('Error al enviar comando Bluetooth:', error);
            }
        }

        function updateRobotBatteryLevel() {
            const batteryElement = document.getElementById('robot-battery-level');
            const randomBattery = Math.floor(Math.random() * 80) + 21;
            batteryElement.textContent = `${randomBattery}%`;
        }

        // --- Image Handling Logic ---
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').style.display = 'block';
                selectedImageBase64 = e.target.result.split(',')[1];
                updateSendButtonState();
            };
            reader.readAsDataURL(file);
        }

        function removeSelectedImage() {
            document.getElementById('image-input').value = '';
            document.getElementById('image-preview').src = '#';
            document.getElementById('image-preview-container').style.display = 'none';
            selectedImageBase64 = null;
            updateSendButtonState();
        }

        // --- Voice Recognition & UI Logic ---
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('mic-button-container').style.display = 'none';
                return;
            }
            recognition = new SpeechRecognition();
            recognition.lang = 'es-MX';
            recognition.onresult = (event) => {
                document.getElementById('chat-input').value = event.results[0][0].transcript;
                updateSendButtonState();
                sendMessage();
            };
            recognition.onstart = () => { isListening = true; document.getElementById('mic-btn').classList.add('listening'); };
            recognition.onend = () => { isListening = false; document.getElementById('mic-btn').classList.remove('listening'); };
        }
        window.toggleVoiceRecognition = () => { if(recognition) isListening ? recognition.stop() : recognition.start(); };
        
        window.updateSendButtonState = () => {
            const hasText = document.getElementById('chat-input').value.trim().length > 0;
            const hasImage = !!selectedImageBase64;
            document.getElementById('mic-button-container').classList.toggle('hidden', hasText || hasImage);
            document.getElementById('send-button-container').classList.toggle('hidden', !hasText && !hasImage);
        };
        
        // --- Initial setup calls ---
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark');
            }
            setupSpeechRecognition();
            updateSendButtonState();
            if (new URLSearchParams(window.location.search).has('oobCode')) {
                showResetPassword();
            }
            document.getElementById('image-input').addEventListener('change', handleImageSelect);
            document.getElementById('remove-image-btn').addEventListener('click', removeSelectedImage);
            // Add event listener for profile image input
            document.getElementById('profile-image-input').addEventListener('change', handleProfileImageSelect);
        });

        window.toggleDarkMode = () => {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        };

        // Make functions globally accessible
        window.switchScreen = switchScreen;
        window.login = login;
        window.register = register;
        window.sendPasswordResetLink = sendPasswordResetLink;
        window.resetPassword = resetPassword;
        window.changePassword = changePassword;
        window.saveNewName = saveNewName;
        window.showEditNameModal = showEditNameModal;
        window.hideEditNameModal = hideEditNameModal;
        window.showPrivacyScreen = showPrivacyScreen;
        window.showDeleteDataConfirmation = showDeleteDataConfirmation;
        window.hideDeleteDataConfirmation = hideDeleteDataConfirmation;
        window.deleteUserData = deleteUserData;
        window.sendMessage = sendMessage;
        window.connectBluetooth = connectBluetooth;
        window.moveRobot = moveRobot;
        window.logout = logout; // Make logout globally accessible
        window.showSubjectDetail = showSubjectDetail; // Re-add this
        window.showActivities = showActivities; // Re-add this
        window.startChatFromActivity = startChatFromActivity;

    </script>
</body>
</html>
